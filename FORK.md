This fork contains patches to demonstrate [structured email (SML)](https://datatracker.ietf.org/doc/draft-ietf-sml-structured-email/) features in thunderbird mobile.
The modified app can both render structured data of mails in the inbox, as well as send mails with structured data.

# Should this be Merged?

We encapsulated our additions as well as possible in their own classes, to make inspecting and potentially merging them straightforward.
That being said, we are aware that there are some aspects of our implementation, specifically the way we render the structured data via html on top of the email, would need to be replaced with a more elegant solution.
However other aspects, like the extraction of structured data, or the extended message-builder could be used as is or with little changes.
In the corresponding sections below we discuss the individual aspects in greater detail.
So the answer the question posed in the header: Not as-is, specific classes could be pulled into upstream, while others serve the purpose of a working proof-of-concept, but would need to be reworked.

We do aim to keep up-to-date with the main project, but given that we don't expect our changes to be directly merged, we don't frequently sync with upstream.

# Features

## Inbound

When opening a given mail, the contents of it are analyzed, and if structured data is found, a corresponding rendering is displayed at the top of the message.
In some cases structured data is also derived (generated) from the mail contents.

### Extraction and Generation of Structured Data

We have placed the code for this in custom `SML*` classes (Mainly `SMLMessageView`), which we then call upon from the existing `MessageViewInfoExtractor`.
We believe that the base **extraction should already be relatively solid as it stands**.
Further **structured data generation based on contents** (should be or already is) **hidden behind advanced user preferences**.

### Extract Deliberately Placed Structured Data

This is for the case, where the sender of the mail included some structured data with the mail.

* Extract multipart/alternative MIME part with the content type `application/ld+json` (this corresponds to the current draft of the SML spec)
* Extracts json-ld (or microdata) from the message's HTML (legacy; this is how some proprietary (e.g. Airline to Gmail) solutions function)
* We also support the case, where a sender wants to include multiple pieces of structured data, and have them appear/ linked in specific locations of the html. This works with `data-id` tags, similar to how images can be embedded using `mid` tags in regular emails. 

### Generate Structured Data from Mail Contents

We also want to demonstrate some cases where we want to show how a given mail with structured data *could* look like,
and for demonstration purposes, generate the corresponding structured data as if it was included in the mail.


* From attachments:
  * We currently generate schema from ics attachments and imip messages (to allow answering calendar invitations with a single click)
* From text:
  * _Experimental_: Verification codes. For messages that contain "code" in the subject line, we try parsing the code from the text, and generate schema representing that code, allowing to copy that code to clipboard with a single click.
  * (_Demo Only_: For selected newsletters, we detect a list of whitelisted urls, for which we show a button, to load-in (and then render) the json-ld of the corresponding web-page.)

    

### Trust

Extracting (and later rendering) structured data might be something a user would want to restrict to trusted senders only.
We have some ideas as to when this trust should be granted, but it is **still a work in progress**.

* Currently in `SMLTrustHelper` we bundle information on
  * If the message has a "good" signature
  * If the user has a contact for the sender
  * If the message headers contain dkim=pass.
* These properties should be combined to a trust decision "should show sml".
* Neither the decision-algorithm, nor the actual prevention of showing sml have been implemented yet.

### Refinement

Before we show the extracted schema data, we perform a refinement step, which filters out properties, of which we know they would not render nicely (like BreadcrumbList).
This is a stopgap, to allow rendering schema that has originally been extracted from Websites, until email senders start including more email oriented structured data.

## Rendering

For rendering the structured data, we have a rather **"hacky" solution**, which works for demonstration purposes, but should be replaced with something more robust:

* For a given piece of structured data, we render a HTML representation, and tack that html to the start of the email html.
* To allow for buttons (that are rendered in html, but whose behaviour is defined in java), we use custom uri schemes, which we overwrite in our extended webview client (`SMLWebViewClientExtensions)
* For poll cards we actually need to invoke some JavaScript, which we temporarily enabled in the WebView(!)
* When refreshing a card's content (for example for a live location) we show the resulting refreshed card in a popup webview.

Instead of all of these workaround a better solution for actual incorporation would be to use native components instead.

### Inline Popup Cards

We consider/ demonstrate one special case of a (cooking) newsletter:
* In this example, a cooking newsletter contains multiple recipes, each with a link, and either
  * Case 1: The mail contains markup data: Then we match up the pieces of structured data with corresponding tags in the html, and show a button at each of those tags
    * Tapping on said button then shows the corresponding rendered markup in a popup (e.g the corresponding recipe card)
    * As long as the mail is fully loaded, this works completely offline
  * Case 2: The mail does not contain markup data (but links match our allow-list). In this case we want to demonstrate how case 1 could look like, if the sender included schema, and after each allowed url show a button.
    * Tapping on said button fetches the json-ld from the corresponding website, and renders the fetched markup.
    * We only go into this case if the corresponding (demoView) user setting is enabled 

### Actions

We support a variety of actions on the markup. The table below shows which buttons we show in which cases, and how they are rendered.

| Category                  | Action              | Implemented                     | Button Shown for                                                                                                                                                                                         | Description                                                                                                                                                                                             | URI-Scheme                                                                                            | URI-Override                                                                                                                                       | Button<br>Rendered<br>As                                                                                                                                                                                                                                                                                                                                                   |
|---------------------------|---------------------|---------------------------------|----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|-------------------------------------------------------------------------------------------------------|----------------------------------------------------------------------------------------------------------------------------------------------------|----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| Calendar                  | Calendar            | Yes                             | * SchemaOrg/Event and SchemaOrg/\*Event (incl. Events derived from ical attachments)<br>* other markups with Start/ End Dates/Times (F.e. Restaurant Reservation); based on present properties, not type | Generates and opens a corresponding ics file. This will typically be handled by the default calendar app, offering to add to calendar                                                                   | `xshareascalendar`                                                                                    | Overridden, custom scheme                                                                                                                          | [event](https://fonts.google.com/icons?icon.size=24&icon.color=%23e3e3e3&selected=Material+Symbols+Outlined:event:FILL@0;wght@400;GRAD@0;opsz@24)                                                                                                                                                                                                                          |
| Calendar                  | IMIP                | Yes                             | IMIP mime parts                                                                                                                                                                                          | Accept/ Decline/ Tentative Buttons send IMIP answer email                                                                                                                                               | `ximip`                                                                                               | Overridden, custom scheme                                                                                                                          | Accept/ "Decline"/ "Tentative"                                                                                                                                                                                                                                                                                                                                             |
| Calendar                  | Meet                | Yes                             | As the two above, but `description` of (generated) SchemaOrg/Event contains a meet.google.com url                                                                                                        | Joins the meet call                                                                                                                                                                                     | `https` just opens the original meet url like any normal web url.                                     | Not overridden, standard scheme                                                                                                                    | [videocam](https://fonts.google.com/icons?icon.size=24&icon.color=%23e3e3e3&selected=Material+Symbols+Outlined:videocam:FILL@0;wght@400;GRAD@0;opsz@24&icon.query=videocam)                                                                                                                                                                                                |
| Contact (verb)            | Call (phone)        | Yes                             | Each `telephone` or `phone` property in a given schema (**recursive search!**)                                                                                                                           | Calls the phone number                                                                                                                                                                                  | `tel`                                                                                                 | Not overridden, standard scheme                                                                                                                    | [call](https://fonts.google.com/icons?icon.size=24&icon.color=%23e3e3e3&selected=Material+Symbols+Outlined:call:FILL@0;wght@400;GRAD@0;opsz@24&icon.query=call)                                                                                                                                                                                                            |
| Contact (verb)            | Email (verb)        | Yes                             | Each `email` property in a given schema (**recursive search!**)                                                                                                                                          | Not to be confused with "share as email" action.<br><br>Acts like a normal mailto. I.e. android will present a list of email clients, the chosen client opens with a compose view to the given address. | `mailto` (compare to row "Respond with SML)                                                           | Overridden (but falls through to normal handler), standard scheme                                                                                  | [mail](https://fonts.google.com/icons?icon.size=24&icon.color=%23e3e3e3&selected=Material+Symbols+Outlined:mail:FILL@0;wght@400;GRAD@0;opsz@24&icon.query=mail)                                                                                                                                                                                                            |
| Map                       | Show                | Yes                             | Each `geo` property in a given schema, that has a jsonObject as a value with the keys `latitude` and `longitude` **recursive search!**)                                                                  | Opens coordinates in a map app                                                                                                                                                                          | `geo`                                                                                                 | Not overridden, standard scheme                                                                                                                    | [map](https://fonts.google.com/icons?icon.size=24&icon.color=%23e3e3e3&selected=Material+Symbols+Outlined:map:FILL@0;wght@400;GRAD@0;opsz@24&icon.query=map)                                                                                                                                                                                                               |
| Map                       | Navigate            | Yes                             | see above                                                                                                                                                                                                | Opens navigation to coordinates in google maps                                                                                                                                                          | `google.navigation`                                                                                   | Not overridden, standard scheme                                                                                                                    | [assistant_direction](https://fonts.google.com/icons?icon.size=24&icon.color=%23e3e3e3&selected=Material+Symbols+Outlined:assistant_direction:FILL@0;wght@400;GRAD@0;opsz@24&icon.query=assistant_direction)                                                                                                                                                               |
| Media                     | Play (audio, video) | Yes                             | A single audio/ video property if it contains a `contentUrl` (no recursive/ deep search)                                                                                                                 | Opens an external media player (google photos, youtube music, vlc, ...) that plays the audio/ video<br>                                                                                                 | `xplaymedia`                                                                                          | Overridden, custom scheme                                                                                                                          | [music_note](https://fonts.google.com/icons?icon.query=music+no&icon.size=24&icon.color=%23e3e3e3&selected=Material+Symbols+Outlined:music_note:FILL@0;wght@400;GRAD@0;opsz@24)<br>[play_circle](https://fonts.google.com/icons?icon.query=video+play&icon.size=24&icon.color=%23e3e3e3&selected=Material+Symbols+Outlined:play_circle:FILL@0;wght@400;GRAD@0;opsz@24)<br> |
| View                      | Refresh via HTTP    | Yes                             | Schema markup that has a `liveUri` (at the top level/ no recursive search)                                                                                                                               | Downloads the schema contained at the liveUri<br>renders that schema in a popup<br><br>This is intended for update such as liveLocation                                                                 | `xreload`                                                                                             | Overridden, custom scheme                                                                                                                          | [replay](https://fonts.google.com/icons?icon.size=24&icon.color=%23e3e3e3&selected=Material+Symbols+Outlined:replay:FILL@0;wght@400;GRAD@0;opsz@24&icon.query=replay)                                                                                                                                                                                                      |
| **Respond with HTTP/SML** | Respond with SML    | Yes                             | Schema markup with potentialActions with a `ConfirmAction` or a `CancelAction`                                                                                                                           | Sends an reply email with the corresponding markup (Confirm/ Deny)                                                                                                                                      | `mailto` with a custom `action` query parameter.<br>E.g. `mailto:foo@example.com?action=CancelAction` | Overridden (custom handling is only executed when uri has `action` query parameter), standard schema+nonstandard (for this scheme) query parameter | Confirm/ "Deny" (based on `name` property of `ConfirmAction` or `CancelAction`)                                                                                                                                                                                                                                                                                            |
| **Respond with HTTP/SML** | Respond with HTTP   | Partial (button is never shown) | Never                                                                                                                                                                                                    | Makes a HTTP call to the given uri                                                                                                                                                                      | `xrequest`                                                                                            | Overridden, custom scheme                                                                                                                          |                                                                                                                                                                                                                                                                                                                                                                            |
| Share                     | Share-out as file   | Yes                             | SchemaOrg/Recepie and SchemaOrg/\*Reservation                                                                                                                                                            | Creates a temporary file containing the jsonld, and shares it                                                                                                                                           | `xshareasfile`                                                                                        | Overridden, custom scheme                                                                                                                          | [share](https://fonts.google.com/icons?icon.size=24&icon.color=%23e3e3e3&selected=Material+Symbols+Outlined:share:FILL@0;wght@400;GRAD@0;opsz@24&icon.query=share)                                                                                                                                                                                                         |
| Share                     | Share as Email      | Yes                             | Always                                                                                                                                                                                                   | Sends user to compose screen in K9 with includes the schema                                                                                                                                             | `xshareasmail`                                                                                        | Overridden, custom scheme                                                                                                                          | [forward_to_inbox](https://fonts.google.com/icons?icon.size=24&icon.color=%23e3e3e3&selected=Material+Symbols+Outlined:forward_to_inbox:FILL@0;wght@400;GRAD@0;opsz@24&icon.query=forward_to_inbox)                                                                                                                                                                        |
| Media                     | Show Web story      | Partial/ Broken                 | Never                                                                                                                                                                                                    | Opens WebView showing that story in a popup.<br>Bug: That WebView has an Invisible Size.                                                                                                                | `xstory`                                                                                              | Overridden, custom scheme                                                                                                                          | Not implemented yet, but suggestion: [web_stories](https://fonts.google.com/icons?icon.size=24&icon.color=%23e3e3e3&selected=Material+Symbols+Outlined:web_stories:FILL@0;wght@400;GRAD@0;opsz@24&icon.query=story)                                                                                                                                                        |
| ?                         | Copy to Clipboard   | Yes                             | Schema markup with `potentialAction` of type `CopyToClipboardAction`                                                                                                                                     | Copies the given text to the clipboard                                                                                                                                                                  | `xclipboard`                                                                                          | Overridden, custom scheme                                                                                                                          | [content_paste](https://fonts.google.com/icons?icon.size=24&icon.color=%23e3e3e3&selected=Material+Symbols+Outlined:content_paste:FILL@0;wght@400;GRAD@0;opsz@24&icon.query=content_paste)                                                                                                                                                                                 |
| View                      | Visit website       | Yes                             | Schema markup that has a `url` (at the top level/ no recursive search)                                                                                                                                   | Opens the url in the browser                                                                                                                                                                            | `https`                                                                                               | Not overridden, standard scheme                                                                                                                    | [link](https://fonts.google.com/icons?icon.size=24&icon.color=%23e3e3e3&selected=Material+Symbols+Outlined:link:FILL@0;wght@400;GRAD@0;opsz@24&icon.query=link)                                                                                                                                                                                                            |
| View                      | Show Barcode        | Yes                             | Never                                                                                                                                                                                                    | Shows (demo) barcode in a popup                                                                                                                                                                         | `xbarcode`                                                                                            | Overridden, custom scheme                                                                                                                          |                                                                                                                                                                                                                                                                                                                                                                            |
| Debug                     | Show Source         | Yes                             | For every card, if "SML debug view mode" user setting is enabled for default account                                                                                                                     | Shows the jsonld source used to render a given card in a popup                                                                                                                                          | `xshowsource`                                                                                         | Overridden, custom scheme                                                                                                                          | [data_object](https://fonts.google.com/icons?icon.size=24&icon.color=%23e3e3e3&selected=Material+Symbols+Outlined:data_object:FILL@0;wght@400;GRAD@0;opsz@24&icon.query=data_object) "Show Source"                                                                                                                                                                         |


## Outbound


There are a number of main ways to send a mail with structured data:

* By interacting with another SML-enabled mail (see [actions](#actions); e.g. "share as email")
* Via urls
  * This could be via a mailto, a received android "share", or a pasted url
  * Most websites contain structured data, in such cases, the structured data is extracted and attached to the mail, as some kind of "advanced link preview"
  * (There is a bug still with share-in in a multi-account setup if the account gets switched before send, the structured data is not included)
* Via attachments (this is more of a debug feature)
  * When sharing json files, or attaching a json file, and the file contains json-ld, it gets added to the message as structured data
* The automatic conversion of an url or an attachment to structured data can be reverted in the send dialog via a toggle (However we have not yet implemented "remembering" the position of the "SML toggle", so pasting a new link or adding a new json attachment could turn it back on).
* We have not yet added support saving a mail with structured data to drafts.

To build the actual structured mail:

* We implemented a special `SmlMessageBuilder` which also allows setting text and html separately from each other, as well as setting an additional alternative part.
* This mail builder is already relatively robust, and could be a general improvement over the existing builder, since it allows for more flexibility when creating emails (could be used as a starting point to compose html mails).
  * We have however not yet added support for PGP with the SmlMessageBuilder.
* With this messageBuilder we support both
  * sending mails with a multipart/alternative MIME part, carrying the structured data (current draft of the SML spec).
  * As well as mails with json-ld in the mail's HTML.

## User settings

We have also added a number of user settings for the purposes of hiding (by default) some additional features

* SML debug view mode: Shows additional ui elements, that allow for analysis of a piece of structured data in a given mail
* SML demo view mode: Enables adding buttons for inline popup cards in a selected few newsletters.
  * The two "view mode" settings currently have the issue that while they are per account settings, we only query the default account's value for these settings.
* SML variant selection: Can switch between sending the newer "dedicated multipart" variant of sml mails, or the legacy "sml in html" variant

## Yatagarasu Theme

We also added a custom theme that we build our for of the app in, to differentiate our forked builds from the official builds.
This theme of course would not need to be merged.
